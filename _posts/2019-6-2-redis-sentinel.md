---
layout: post
title: Redis哨兵机制
categories: JavaSE
tags: redis
author: fidemyuan
---

## 为什么要用哨兵机制

当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。

##　什么是哨兵模式

哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。

## 哨兵的作用

（1）通过发送命令，让Redis服务器返回监控其运行状态，包括主服务器和从服务器。<br>

（2）当哨兵监测到master宕机，会自动将slave切换成master，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让它们切换主机。<br>

##多哨兵模式

一个哨兵进程对Redis服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了多哨兵模式。<br>

## redis哨兵领导者、主节点选举、故障转移过程

### 1.主观下线与客观下线

假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象成为主观下线。<br>

当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为客观下线。<br>

客观下线是多哨兵对主机宕机达成的一个共识。<br>

### 2.选举sentinel领导者 

使用的raft算法(https://raft.github.io)，大致思路：<br>

1、每个做主观下线的sentinel节点像其他sentinel节点发送命令，要求将自己设置为领导者<br>

2、接收到的sentinel可以同意或者拒绝<br>

3、如果该sentinel节点发现自己的票数已经超过半数并且超过了quorum<br>

4、如果此过程选举出了多个领导者，那么将等待一段时重新进行选举<br>


### 3.哨兵领导者进行故障迁移

1、sentinel的领导者从slave中选举出合适的从节点进行故障转移<br>

 （1）选择健康状态从节点（排除主观下线、断线），排除5秒钟没有心跳的、排除主节点失联超过10*down-after-millisecends<br>

 （2）选择slave-priority高的从节点优先级列表<br>

 （3）选择偏移量大的<br>

 （4）选择runid小的<br>

2、对选取的slave执行slave of no one<br>

3、更新应用程序端的链接到新的主节点<br>

4、对其他从节点变更master为新的节点<br>

5、修复原来的master并将其设置为新master的slave<br>
