---
layout: post
title: java中的锁分析
categories: JavaSE
tags: 多线程
author: fidemyuan
---

## 按性质分类

乐观锁/悲观锁<br>
独享锁/共享锁<br>
互斥锁/读写锁<br>
可重入锁<br>
公平锁/非公平锁<br>
分段锁<br>
偏向锁/轻量级锁/重量级锁<br>
自旋锁<br>


## 概念介绍

### 乐观锁与悲观锁

乐观锁：很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。乐观锁适用于多读的应用类型，这样可以提高吞吐量，在Java中java.util.concurrent.atomic包下面的原子变量类就是使用了乐观锁的一种实现方式CAS(Compare and Swap 比较并交换)实现的。<br>

悲观锁：总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会阻塞直到它拿到锁。比如Java里面的同步原语synchronized关键字的实现就是悲观锁。<br>

悲观锁适合写操作非常多的场景，乐观锁适合读操作非常多的场景，不加锁会带来大量的性能提升。<br>

悲观锁在Java中的使用，就是利用各种锁。<br>

乐观锁在Java中的使用，是无锁编程，常常采用的是CAS算法，典型的例子就是原子类，通过CAS自旋实现原子操作的更新。<br>

### 独享锁与共享锁

独享锁是指该锁一次只能被一个线程所持有。<br>

共享锁是指该锁可被多个线程所持有。<br>

对于Java ReentrantLock而言，其是独享锁。但是对于Lock的另一个实现类ReadWriteLock，其读锁是共享锁，其写锁是独享锁。<br>

读锁的共享锁可保证并发读是非常高效的，读写，写读，写写的过程是互斥的。<br>

独享锁与共享锁也是通过AQS来实现的，通过实现不同的方法，来实现独享或者共享。<br>

对于Synchronized而言，当然是独享锁。<br>

###  互斥锁/读写锁

上面讲的独享锁/共享锁就是一种广义的说法，互斥锁/读写锁就是具体的实现。<br>

互斥锁在Java中的具体实现就是ReentrantLock。<br>

读写锁在Java中的具体实现就是ReadWriteLock。<br>

### 可重入锁

可重入锁又名递归锁，是指在同一个线程在外层方法获取锁的时候，在进入内层方法会自动获取锁。说的有点抽象，下面会有一个代码的示例。<br>

对于Java ReetrantLock而言，从名字就可以看出是一个重入锁，其名字是Re entrant Lock 重新进入锁。<br>
对于Synchronized而言，也是一个可重入锁。可重入锁的一个好处是可一定程度避免死锁。<br>


	、 synchronized void setA() throws Exception{
	 　　Thread.sleep(1000);
	 　　setB();
	 }
	 
	 synchronized void setB() throws Exception{
	 　　Thread.sleep(1000);
	 }、

上面的代码就是一个可重入锁的一个特点。如果不是可重入锁的话，setB可能不会被当前线程执行，可能造成死锁。<br>

### 公平锁/非公平锁

公平锁是指多个线程按照申请锁的顺序来获取锁。<br>

非公平锁是指多个线程获取锁的顺序并不是按照申请锁的顺序，有可能后申请的线程比先申请的线程优先获取锁。有可能，会造成优先级反转或者饥饿现象。<br>

对于Java ReetrantLock而言，通过构造函数指定该锁是否是公平锁，默认是非公平锁。非公平锁的优点在于吞吐量比公平锁大。<br>

对于Synchronized而言，也是一种非公平锁。由于其并不像ReentrantLock是通过AQS的来实现线程调度，所以并没有任何办法使其变成公平锁。<br>

### 偏向锁/轻量锁/重量锁

不同的线程争夺锁的程度。<br>

偏向锁是指一段同步代码一直被一个线程所访问，那么该线程会自动获取锁。降低获取锁的代价。<br>

轻量级锁是指当锁是偏向锁的时候，被另一个线程所访问，偏向锁就会升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，提高性能。<br>

重量级锁是指当锁为轻量级锁的时候，另一个线程虽然是自旋，但自旋不会一直持续下去，当自旋一定次数的时候，还没有获取到锁，就会进入阻塞，该锁膨胀为重量级锁。重量级锁会让他申请的线程进入阻塞，性能降低。<br>

## 自旋锁

在Java中，自旋锁是指尝试获取锁的线程不会立即阻塞，而是采用循环的方式去尝试获取锁，这样的好处是减少线程上下文切换的消耗，缺点是循环会消耗CPU。<br>